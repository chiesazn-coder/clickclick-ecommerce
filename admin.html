<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clickclick Admin</title>
  <link rel="stylesheet" href="./dist/output.css?v=prod" />
  <style>
    body { font-family: sans-serif; background:#f9fafb; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:16px; }
    .hidden { display:none; }
    #login-modal { background:rgba(0,0,0,0.6); }
    button.btn { background:#111; color:#fff; padding:6px 10px; border-radius:6px; }
    button.btn.secondary { background:#eee; color:#111; }
  </style>
</head>
<body class="p-6">
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Orders</h1>
    <div class="flex items-center gap-3">
      <div id="api-status" class="text-sm text-gray-500">Checking...</div>
      <button id="logoutBtn" class="btn secondary">Logout</button>
    </div>
  </header>

  <!-- Login Modal -->
  <div id="login-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-lg">
      <h2 class="text-lg font-semibold mb-4">Admin Login</h2>
      <form id="login-form" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Email</label>
          <input id="login-email" type="email" required class="w-full border px-3 py-2 rounded" />
        </div>
        <div>
          <label class="block text-sm mb-1">Password</label>
          <input id="login-pass" type="password" required class="w-full border px-3 py-2 rounded" />
        </div>
        <p id="login-err" class="text-sm text-red-600"></p>
        <button type="submit" class="w-full bg-black text-white py-2 rounded hover:opacity-90">Login</button>
      </form>
    </div>
  </div>

  <!-- Table -->
  <div id="orders" class="card">
    <p id="orders-err" class="text-red-600 text-sm"></p>
    <table class="w-full text-sm mt-2">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2">ORDER</th>
          <th>CUSTOMER</th>
          <th>TOTAL</th>
          <th>PAYMENT</th>
          <th>FULFILLMENT</th>
          <th>ACTIONS</th> <!-- <== TAMBAH -->
        </tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>
  </div>

  <script>
    const API = "http://localhost:3000"; // backend kamu
    let ADM_TOKEN = localStorage.getItem("adm_tok") || "";

    const statusEl = document.getElementById("api-status");
    const loginModal = document.getElementById("login-modal");
    const loginForm = document.getElementById("login-form");
    const loginErr = document.getElementById("login-err");
    const ordersBody = document.getElementById("orders-body");
    const ordersErr = document.getElementById("orders-err");
    const logoutBtn = document.getElementById("logoutBtn");

    // format rupiah sederhana
    const rupiah = n => "Rp " + Number(n||0).toLocaleString("id-ID");

    // Helper fetch dengan Authorization Bearer
    async function api(path, opts = {}) {
      const headers = {"Content-Type":"application/json", ...(opts.headers||{})};
      if (ADM_TOKEN) headers["Authorization"] = "Bearer " + ADM_TOKEN;
      const r = await fetch(API + path, { ...opts, headers, credentials: "include" });
      if (r.status === 401) { showLogin(); throw new Error("Unauthorized"); }
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    function showLogin(){ loginModal.classList.remove("hidden"); }
    function hideLogin(){ loginModal.classList.add("hidden"); }

    async function loadOrders() {
      ordersErr.textContent = "";
      ordersBody.innerHTML = "";
      try {
        const data = await api("/api/orders");
        if (!data.orders || !data.orders.length) {
          ordersBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">No orders yet</td></tr>`;
          return;
        }
        data.orders.forEach(o => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="py-2">${o.order_id}</td>
            <td>${o.customer?.name||''}<br><span class="text-xs text-gray-500">${o.customer?.email||''}</span></td>
            <td>${rupiah(o.total)}</td>
            <td>${o.status}</td>
            <td>${o.fulfillment?.status||''}</td>
            <td>
              ${o.status === "PAID"
                ? `<button class="btn" onclick="printReceipt('${o.order_id}')">Cetak Resi</button>`
                : `<span class="text-xs text-gray-400">-</span>`}
            </td>
          `;
          ordersBody.appendChild(tr);
        });
      } catch(e) {
        ordersErr.textContent = "Error: " + e.message;
      }
    }

    // Logout
    logoutBtn.addEventListener("click", async () => {
      try {
        await fetch(API + "/api/auth/logout", { method: "POST", credentials: "include" });
      } finally {
        localStorage.removeItem("adm_tok");
        ADM_TOKEN = "";
        showLogin();
      }
    });

    // Login submit
    loginForm.addEventListener("submit", async e => {
      e.preventDefault();
      loginErr.textContent = "";
      try {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-pass").value;
        const r = await fetch(API + "/api/auth/login", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({email,password}),
          credentials: "include"
        });
        if (!r.ok) { loginErr.textContent = "Login failed"; return; }
        const data = await r.json();
        ADM_TOKEN = data.token || "";
        localStorage.setItem("adm_tok", ADM_TOKEN);
        hideLogin();
        loadOrders();
      } catch (err) {
        loginErr.textContent = err.message || "Failed to fetch";
      }
    });

    // Initial check
    (async () => {
      try {
        await api("/api/health");
        statusEl.textContent = "API OK";
        statusEl.className = "text-green-600 text-sm";
        loadOrders();
      } catch(e) {
        statusEl.textContent = "API ERR";
        statusEl.className = "text-red-600 text-sm";
        showLogin();
      }
    })();

    // CETAK RESI â€” pakai helper api() supaya bawa Bearer token
    async function printReceipt(orderId) {
      try {
        const order = await api(`/api/orders/${orderId}`);
        const popup = window.open("", "_blank", "width=600,height=800");
        popup.document.write(`
          <html>
          <head>
            <title>Resi Order ${order.order_id}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h2 { text-align: center; }
              table { width: 100%; border-collapse: collapse; margin-top: 10px; }
              td, th { border: 1px solid #333; padding: 6px; text-align: left; }
              .right { text-align: right; }
            </style>
          </head>
          <body onload="window.print();window.close()">
            <h2>Resi Pembelian</h2>
            <p><strong>Order ID:</strong> ${order.order_id}</p>
            <p><strong>Nama:</strong> ${order.customer?.name || '-'}</p>
            <p><strong>Email:</strong> ${order.customer?.email || '-'}</p>
            <p><strong>Telp:</strong> ${order.customer?.phone || '-'}</p>
            <hr/>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Qty</th>
                  <th class="right">Harga</th>
                  <th class="right">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${order.items.map(i => `
                  <tr>
                    <td>${i.title}</td>
                    <td>${i.qty}</td>
                    <td class="right">${rupiah(i.price)}</td>
                    <td class="right">${rupiah(i.price * i.qty)}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
            <p class="right"><strong>Total: ${rupiah(order.total)}</strong></p>
            <hr/>
            <p>Status Pembayaran: <strong>${order.status}</strong></p>
            <p><em>Terima kasih telah berbelanja di toko kami</em></p>
          </body>
          </html>
        `);
        popup.document.close();
      } catch (err) {
        alert("Gagal ambil order: " + (err.message || err));
      }
    }
    // expose ke global untuk onclick
    window.printReceipt = printReceipt;
  </script>
</body>
</html>
