<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Terima kasih â€” Clickclick</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--ink:#0b1020;--muted:#6b7280;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--bg:#f7f7fb;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:900px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px}
    h1{margin:0 0 8px;font-size:28px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:2fr 1.2fr}}
    .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .total{font-size:22px;font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600}
    .tag.ok{background:#ecfdf5;color:#065f46}
    .tag.pending{background:#fffbeb;color:#92400e}
    .tag.fail{background:#fef2f2;color:#991b1b}
    .items{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .item{display:flex;gap:12px;align-items:center}
    .thumb{width:56px;height:56px;border-radius:10px;background:#f3f4f6;object-fit:cover}
    .btn{display:inline-flex;align-items:center;justify-content:center;height:44px;padding:0 16px;border-radius:10px;
         border:1px solid #111827;background:#111827;color:#fff;text-decoration:none;font-weight:600}
    .btn.ghost{background:#fff;color:#111827}
    .small{font-size:12px}
    .hr{height:1px;background:#f1f1f3;margin:16px 0}
  </style>
</head>

<body>
  <div class="wrap grid">
    <!-- Left: order -->
    <section class="card">
      <h1>Terima kasih! ðŸŽ‰</h1>
      <div id="statusWrap" class="muted small">Memuat statusâ€¦</div>

      <div class="hr"></div>

      <!-- Membership banner -->
      <div id="memberBanner" class="card" style="display:none; margin:12px 0; padding:14px; border-style:dashed;">
        <div style="font-weight:700; margin-bottom:4px;">Membership aktif ðŸŽ‰</div>
        <div id="memberText" class="small muted"></div>
      </div>

      <h3>Ringkasan pesanan</h3>
      <div id="items" class="items"></div>

      <div class="hr"></div>

      <div class="row"><span>Subtotal</span><strong id="sub">Rp 0</strong></div>
      <div class="row muted"><span>Ongkir</span><span id="ship">Rp 0</span></div>
      <div class="row total"><span>Total</span><span id="tot">Rp 0</span></div>

      <div class="hr"></div>

      <div class="row">
        <a id="back" class="btn ghost" href="./index.html">Kembali ke toko</a>
        <a id="invoice" class="btn" target="_blank" rel="noopener">Lihat di Dashboard (JSON)</a>
      </div>
      <p class="small muted" id="note"></p>
    </section>

    <!-- Right: customer -->
    <aside class="card">
      <h3>Detail penerima</h3>
      <div class="small" id="cust">Memuatâ€¦</div>
    </aside>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = window.PUBLIC_URL || 'https://68859790617a.ngrok-free.app';
  
    // ====== Utils ======
    const fmt  = n => new Intl.NumberFormat('id-ID').format(Math.max(0, Math.floor(n||0)));
    const toAbs = (src) => { try { return new URL(src || 'assets/placeholder.png', document.baseURI).href; } catch { return src || 'assets/placeholder.png'; } };
    const memberBanner = document.getElementById('memberBanner');
    const memberText   = document.getElementById('memberText');
  
    // Ambil order_id: prioritas query â†’ sessionStorage â†’ localStorage
    const q = new URLSearchParams(location.search);
    const orderId =
      q.get('order_id') ||
      q.get('orderId') ||
      sessionStorage.getItem('last_order_id') ||
      localStorage.getItem('last_order_id') || '';
  
    document.getElementById('note').textContent =
      orderId ? `Order: ${orderId}` : 'Order tidak diketahui';
  
    // bersihkan cart lokal
    localStorage.removeItem('cc_cart_v1');
  
    const statusWrap = document.getElementById('statusWrap');
    const itemsEl = document.getElementById('items');
    const subEl = document.getElementById('sub');
    const shipEl = document.getElementById('ship');
    const totEl = document.getElementById('tot');
    const custEl = document.getElementById('cust');
    const invBtn = document.getElementById('invoice');
  
    function tag(status){
      const s = String(status||'').toUpperCase();
      let cls='pending', txt='Menunggu';
      if (s==='PAID'||s==='SETTLEMENT') { cls='ok'; txt='Lunas'; }
      else if (s==='CANCELLED'||s==='DENIED'||s==='EXPIRED') { cls='fail'; txt=s==='EXPIRED'?'Kedaluwarsa':'Gagal'; }
      return `<span class="tag ${cls}">Status: ${txt}</span>`;
    }
  
    async function loadOnce(){
      if (!orderId) throw new Error('order_id kosong');
  
      let o;
      try{
        const r = await fetch(`${API_BASE}/api/orders/${encodeURIComponent(orderId)}`, {
          headers:{'ngrok-skip-browser-warning':'true'}
        });
        if (!r.ok) throw new Error('HTTP '+r.status);
        o = await r.json();
      }catch(e){
        statusWrap.innerHTML = '<span class="tag fail">Gagal mengambil order</span>';
        itemsEl.innerHTML = '<div class="small muted">Tidak bisa memuat item. Coba refresh.</div>';
        throw e;
      }
  
      statusWrap.innerHTML = `${tag(o.status)} <span class="small muted">Order ID: ${orderId}</span>`;
  
      // render items
      const srcItems = (o.items || []).map(it => ({
        title: it.title || 'Item',
        price: Number(it.price)||0,
        qty: Number(it.qty)||1,
        image: toAbs(it.image)
      }));
  
      itemsEl.innerHTML = srcItems.map(it => `
        <div class="item">
          <img class="thumb" src="${it.image}" alt="">
          <div style="flex:1">
            <div><strong>${it.title}</strong></div>
            <div class="small muted">Qty ${it.qty}</div>
          </div>
          <div><strong>Rp ${fmt(it.price*it.qty)}</strong></div>
        </div>
      `).join('') || '<div class="small muted">Tidak ada item.</div>';
  
      subEl.textContent = `Rp ${fmt(o.subtotal || 0)}`;
      shipEl.textContent = `Rp ${fmt(o.shippingFee || 0)}`;
      totEl.textContent = `Rp ${fmt(o.total || 0)}`;
  
      // customer box
      const c = o.customer || {};
      const addr = c.address || {};
      custEl.innerHTML = `
        <div><strong>${c.name || 'Guest'}</strong></div>
        <div class="muted small">${c.email || '-'}</div>
        <div class="small" style="margin-top:8px">
          ${addr.line1 || ''} ${addr.line2 || ''}<br>
          ${addr.city || ''} ${addr.province || ''} ${addr.zip || ''}<br>
          ${addr.country || 'ID'}
        </div>
        <div class="small muted" style="margin-top:8px">Phone: ${c.phone || '-'}</div>
      `;
  
      invBtn.href = `${API_BASE}/api/orders/${encodeURIComponent(orderId)}`;
  
      // === Membership banner ===
      try {
        const ssUid = localStorage.getItem('cc_user_id') || sessionStorage.getItem('cc_user_id');
        const st = String(o.status || '').toUpperCase();
        const isPaid = (st === 'PAID' || st === 'SETTLEMENT');
        if (o.userId && isPaid) {
          memberBanner.style.display = 'block';
          const nama  = c.name || 'Member';
          const email = c.email || '(tanpa email)';
          if (ssUid && ssUid === o.userId) {
            memberText.innerHTML = `
              Hai <strong>${nama}</strong>! Kami sudah membuat akun membership memakai email
              <strong>${email}</strong>. Mulai sekarang, pesananmu otomatis terhubung ke akun ini.
            `;
          } else {
            memberText.innerHTML = `
              Akun membership untuk email <strong>${email}</strong> sudah aktif dan terhubung ke pesanan ini.
            `;
          }
        } else {
          memberBanner.style.display = 'none';
        }
      } catch (_) {
        memberBanner.style.display = 'none';
      }
  
      return String(o.status||'').toUpperCase();
    }
  
    // Polling status (tiap 3s sampai final)
    let tries = 0, timer;
    async function poll(){
      try{
        const st = await loadOnce();
        const done = ['PAID','SETTLEMENT','EXPIRED','DENIED','CANCELLED'].includes(st);
        if (done || tries++ > 40) clearInterval(timer);
      }catch(e){
        console.error(e);
        if (tries++ > 40) clearInterval(timer);
      }
    }
    if (orderId) {
      poll();
      timer = setInterval(poll, 3000);
    } else {
      statusWrap.innerHTML = '<span class="tag fail">Order ID tidak ditemukan</span>';
    }
  </script>
  
</body>
</html>
